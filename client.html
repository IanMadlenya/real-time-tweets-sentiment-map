<!DOCTYPE html>
{% autoescape true %}
<html>
  <head>
  	<title>Tweets on Google Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet" type="text/css">

    <style type="text/css">
      html {height: 100%; width: 100%; text-align:center;}
      body {width:98%; height:98%; margin:auto;}
      img {border:none; max-width: none;}
    </style>

    <script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDNc0dmlvo53X4djeek5mOLB3Q0ETqCg7w&libraries=places&sensor=true">
    </script>
    <script type="text/javascript">
      var map;
      var current_lati;
      var current_longi;

      function initialize() {
          var mapOptions = {
                center: new google.maps.LatLng(48.463104,-123.312141),
                zoom: 2,
                mapTypeId: google.maps.MapTypeId.ROADMAP
              };
          map = new google.maps.Map(document.getElementById("map_canvas"),
                  mapOptions);
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position) {
                  current_lati = position.coords.latitude;
                  current_longi = position.coords.longitude;
                  var pos = new google.maps.LatLng(current_lati, current_longi);
                  
                  map.setCenter(pos);
                  var icon = new google.maps.MarkerImage("http://www.google.com/intl/en_us/mapfiles/ms/micons/green-dot.png");
                  var marker = new google.maps.Marker({
                      map: map,
                      title: "",
                      position: pos,
                      draggable:true,
                      animation: google.maps.Animation.DROP,
                      icon: icon
                  });  
                  marker.setMap(map);
                  var infowindow = new google.maps.InfoWindow({
                      content: "You are here."
                  });
                  google.maps.event.addListener(marker, 'click', function(){
                      if (marker.getAnimation() != null) {
                        marker.setAnimation(null); 
                        if(infowindow.getMap() != null) infowindow.close();          
                      } else {
                        marker.setAnimation(google.maps.Animation.BOUNCE);
                        infowindow.open(map,marker);
                      }
                  });

                  document.getElementById("po_lati").value = current_lati;
                  document.getElementById("po_longi").value = current_longi;

              }, function() {
                  handleNoGeolocation(true);
              });
          } else {
              handleNoGeolocation(false);
          } 
      }

     // google.maps.event.addDomListener(window, 'load', initialize);
      function handleNoGeolocation(errorFlag) {
      if (errorFlag) {
          var content = 'Error: The Geolocation service failed. Enter your Address in the search bar.';
      } else {
          var content = 'Error: Your browser doesn\'t support geolocation. Try Chrome or Firefox';
      }
      var options = {
          map: map,
          position: new google.maps.LatLng(48.463104,-123.312141),
          content: content
      };
      var infowindow = new google.maps.InfoWindow(options);
      map.setCenter(options.position);
      }
    </script>


  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
  <script type="text/javascript" src="jquery-1.9.0.min.js" tppabs="jquery-1.9.0.min.js"></script>
  <script type="text/javascript" src="http://code.jquery.com/jquery-migrate-1.0.0.js"> </script>
  <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

    <script type = "text/javascript">
    $(document).ready(function()
    {
        google.maps.event.addDomListener(window, 'load', initialize);
        $("#gettweetbutton").click(gettweets);
        $("#refreshbutton").click(initialize);
        $("#gettrends").click(gettrends);
    });
    function gettweets(){
      var keyword = document.getElementById("key").value;
      var tweet_num = document.getElementById("tweet_num").value;
      if (keyword == ''){
        alert("Please enter a keyword!");
      }
      else if(tweet_num == ''){
        alert("Please enter a number!")
      }
      $.ajax({
             url: "/",
             type: "POST",
             data: {
                buttonid:"gettweets",
                keyword: keyword,
                tweet_num: tweet_num,
                pos_lati: current_lati,
                pos_longi: current_longi
             },
             dataType: "json",
             success: showtweets,
             error: function (data) {
                    alert("Fail to get tweets!");
              }
      });
    }
    function showtweets(data){
      if (data.search_status == 1){
        alert("Sorry. I have tried my best but only find "+data.count+" tweets...");
      }
      for (var i = 0, len = data.tweets.length; i<len; i++){

          var pos = new google.maps.LatLng(data.tweets[i].geo[0], data.tweets[i].geo[1]);  
          var title = data.tweets[i].status+"<br>Sentiment Value: "+data.tweets[i].sentiment;
          var sentiment = data.tweets[i].sentiment;
          var source_url = data.tweets[i].source;
          showeach(title, pos, sentiment, source_url);

      } 
    }

    function showeach(title, pos, sentiment,source_url){
        var icon;
        if (sentiment > 0){
          html = '<IMG BORDER="0" SRC="https://pbs.twimg.com/media/BWq5Hy9CEAEMUOF.jpg" height = "30" width = "30">';
          icon = new google.maps.MarkerImage("http://www.google.com/intl/en_us/mapfiles/ms/micons/red-dot.png");
        }
        else if (sentiment == 0){
          html = '<IMG BORDER="0" SRC="https://pbs.twimg.com/media/BWq5MPRCcAEu_4l.jpg" height = "30" width = "30">';
          icon = new google.maps.MarkerImage("http://www.google.com/intl/en_us/mapfiles/ms/micons/yellow-dot.png");
        }
        else if (sentiment < 0){
          html = '<IMG BORDER="0" SRC="https://pbs.twimg.com/media/BWq5KNJCIAAaC-h.jpg" height = "30" width = "30">';
          icon = new google.maps.MarkerImage("http://www.google.com/intl/en_us/mapfiles/ms/micons/blue-dot.png");
        }

        var marker = new google.maps.Marker({
            map: map,
            title: 'source:'+source_url,
            position: pos,
            draggable:true,
            animation: google.maps.Animation.DROP,
            icon: icon
        });
        marker.setMap(map);

        var infowindow = new google.maps.InfoWindow({
          content: ''
        })
        infowindow.setContent(html);
        infowindow.setContent(title+html);
        google.maps.event.addListener(marker, 'click', function(){          
            if (marker.getAnimation() != null) {
              marker.setAnimation(null); 
              if(infowindow.getMap() != null) infowindow.close();          
            } else {
              marker.setAnimation(google.maps.Animation.BOUNCE);
              infowindow.open(map,marker);
            }
        });
    }


    function gettrends(){
      $.ajax({
             url: "/",
             type: "POST",
             data: {
                buttonid: "gettrends",
                pos_lati: current_lati,
                pos_longi: current_longi
             },
             dataType: "json",
             success: showtrends,
             error: function (data) {
                    alert("Fail to get tweets!");
              }
      });
    }
    function showtrends(data){
      $("#trends").html(data["content"]);
    }

    </script>


  </head>

  <body>
  	<table style="border:0; width:100%; height:100%;">
  		<tr>
  			<td colspan="3" style="background-color:#FFA500; height:10%; text-align:center;">
  				<h1>Tweets on Google Map</h1>
  		  </td>
  		</tr>

  		<tr>
  			<td style="background-color:#FFD700;width:20%; height:85%; text-align:left;vertical-align:top">
          <!--
  				<b>Notes:</b>
  			    <li><b>Intention:</b><br>
                This webapp is used to<br>
                1) search most recent tweets based on keyword, make a simple sentiment analysis and show it on Google Map;<br>
                2) get the top 10 trending topics for the tweets in your location.<br>
            <li><b>Instructions:</b><br>
                1) The initial view is a Google Map with a mark of your location.<br>
                2) Enter a keyword in the text box that indicates "Enter Keyword for searching".<br>
                3) Enter a number (that is how many tweets you want to get for each searching) in the text box that indicates "Enter number for each search".<br>
                4) Click the button "Get Tweets" and wait for while, you will see some markers on Google Map which is attached with a infomation window symbolizing the sentiment of this tweet (smile or normal or cry). Let the mouse stay on the marker, you can see original information of the corresponding tweet.<br>
                5) Click the button "Clear" to remove all the markers on the map.<br>
                6) The column on the right shows the top 10 trending topics for the tweets in your location.<br>
              -->
              <br><br>
          <IMG BORDER="0" SRC="http://www.google.com/intl/en_us/mapfiles/ms/micons/green-dot.png"><br> Your Location <br><br><br>
          <IMG BORDER="0" SRC="http://www.google.com/intl/en_us/mapfiles/ms/micons/red-dot.png"><br>Sentiment of the tweet is positive<br><br><br>
          <IMG BORDER="0" SRC="http://www.google.com/intl/en_us/mapfiles/ms/micons/yellow-dot.png"><br>Sentiment of the tweet is even-handed<br><br><br>
          <IMG BORDER="0" SRC="http://www.google.com/intl/en_us/mapfiles/ms/micons/blue-dot.png"><br>Sentiment of the tweet is negative<br>

  		  </td>
        <td>
          <table style="width:100%; height:100%;">
            <tr style="height:5%;">
                <td style="width:10%"><input id="key" name="key" type="text" placeholder="Enter Keyword for searching"/> </td>
                <td style="width:10%"><input id="tweet_num" name="tweet_num" type="text" placeholder="Enter number for each search"/> </td>
                <td style="width:10%"><input id="gettweetbutton" value="Get Tweets" type="submit"/></td>
                <td style="width:10%"><input id="refreshbutton" value="Clear" type="submit"/></td>
                <td style="width:10%"></td>
            </tr>
            <tr>
              <td id="map_canvas" style="height: 80%;" colspan="5" />
            </tr>
          </table>
        </td>
        <td style="background-color:#FFD700;width:15%; height:85%;vertical-align:top">
          <br><b>Top 10 trending topics of tweets in your location:</b><br><br>
          <table style = "text-align:center">
            <input id="gettrends" value="Click to get it!" type="submit"/><br><br><br>
            <div id="trends">
            </div>
         </table>
        </td>
  		</tr>

  		<tr>
  			<td id="footer" colspan="3" style="background-color:#FFA500;clear:both;text-align:center; height:5%">
  			    Copyright 2013 © Weiliang Wang
  		  </td>
  		</tr>
	  </table>
  </body>
</html>
{% endautoescape %}
